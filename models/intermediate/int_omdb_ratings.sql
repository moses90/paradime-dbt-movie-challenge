/*
This model extracts the ratings from the 3 known sources (Internet Movie Database, Rotten Tomatoes, Metacritic) from the JSON column RATINGS.
It then scales the ratings from different sources to a 0-1 scale.
*/

WITH CTE_FLATTENED_RATINGS AS (
  SELECT
    O.IMDB_ID,
    FLATTENED_RATINGS.VALUE:Source::STRING AS SOURCE,
    FLATTENED_RATINGS.VALUE:Value::STRING AS RATING_VALUE
  FROM
    {{ ref('stg_omdb_movies') }} AS O,
    LATERAL FLATTEN(input => O.RATINGS) AS FLATTENED_RATINGS
),

CTE_GROUPED_RATINGS AS (
  SELECT
    IMDB_ID,
    MAX(CASE WHEN SOURCE = 'Internet Movie Database' THEN RATING_VALUE END) AS IMDB_RATING,
    MAX(CASE WHEN SOURCE = 'Rotten Tomatoes' THEN RATING_VALUE END) AS ROTTEN_TOMATOES_RATING,
    MAX(CASE WHEN SOURCE = 'Metacritic' THEN RATING_VALUE END) AS METACRITIC_RATING
  FROM
    CTE_FLATTENED_RATINGS
  GROUP BY 1
),

CTE_TRANSFORM_SCORES AS (
  SELECT
    IMDB_ID,
    CAST(SUBSTRING(IMDB_RATING, 1, LENGTH(IMDB_RATING) - 3) AS NUMERIC) / 10 AS IMDB_RATING,
    CAST(SUBSTRING(ROTTEN_TOMATOES_RATING, 1, LENGTH(ROTTEN_TOMATOES_RATING) - 1) AS NUMERIC) / 100 AS ROTTEN_TOMATOES_RATING,
    CAST(SUBSTRING(METACRITIC_RATING, 1, LENGTH(METACRITIC_RATING) - 4) AS NUMERIC) / 100 AS METACRITIC_RATING
  FROM CTE_GROUPED_RATINGS
)

SELECT *
FROM CTE_TRANSFORM_SCORES
