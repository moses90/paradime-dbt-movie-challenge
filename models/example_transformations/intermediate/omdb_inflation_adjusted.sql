WITH RELEASE_MONTH_YEAR AS (
SELECT IMDB_ID,
CASE WHEN RELEASED_DATE IS NULL THEN NULL
ELSE MONTH(RELEASED_DATE) END
AS RELEASE_MONTH,
CASE WHEN RELEASED_DATE IS NULL THEN RELEASE_YEAR
ELSE YEAR(RELEASED_DATE) END
AS RELEASE_YEAR
FROM
{{ source('PARADIME_MOVIE_CHALLENGE', 'OMDB_MOVIES') }}
WHERE RELEASE_YEAR>=1990
),

INFLATION_INDEX_LOOKUP AS (
SELECT IMDB_ID,
RELEASE_MONTH,
RELEASE_YEAR,
CASE
WHEN RELEASE_MONTH = 1 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Jan
WHEN RELEASE_MONTH = 2 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Feb
WHEN RELEASE_MONTH = 3 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Mar
WHEN RELEASE_MONTH = 4 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Apr
WHEN RELEASE_MONTH = 5 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.May
WHEN RELEASE_MONTH = 6 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Jun
WHEN RELEASE_MONTH = 7 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Jul
WHEN RELEASE_MONTH = 8 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Aug
WHEN RELEASE_MONTH = 9 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Sep
WHEN RELEASE_MONTH = 10 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Oct
WHEN RELEASE_MONTH = 11 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Nov
WHEN RELEASE_MONTH = 12 THEN {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Dec
ELSE {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.Dec
END AS INFLATION_INDEX

FROM RELEASE_MONTH_YEAR
INNER JOIN 
{{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }} 
ON {{ source('PARADIME_MOVIE_CHALLENGE_EXTRA', 'INFLATION_2023') }}.YEAR = RELEASE_YEAR
)

SELECT omdb_source.*,
CASE WHEN omdb_source.BOX_OFFICE IS NULL THEN NULL
ELSE omdb_source.BOX_OFFICE * INFLATION_INDEX_LOOKUP.INFLATION_INDEX
END AS ADJ_BOX_OFFICE
FROM 
{{ source('PARADIME_MOVIE_CHALLENGE', 'OMDB_MOVIES') }} AS omdb_source
LEFT JOIN INFLATION_INDEX_LOOKUP
ON omdb_source.IMDB_ID = INFLATION_INDEX_LOOKUP.IMDB_ID




